<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <title>Cavit Çetin ÖZTÜRK - KOSİNÜS AKADEMİ</title>
    <style>
        .header .logo {
            max-height: 180px;
            /* logonun boyunu buradan ayarlayabilirsin */
            margin-bottom: 10px;
        }


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Mobil öncelikli CSS */
        @media screen and (max-width: 768px) {

            html,
            body {
                font-size: 14px;
                overflow-x: hidden;
            }

            .container {
                margin: 0 !important;
                border-radius: 0 !important;
                min-height: 100vh !important;
            }

            .header {
                padding: 10px !important;
                flex-direction: column !important;
                text-align: center !important;
            }

            .header h1 {
                font-size: 1.5em !important;
            }

            .header p {
                font-size: 0.9em !important;
            }

            .header .logo {
                max-height: 60px !important;
                margin-bottom: 5px !important;
            }

            .top-controls {
                flex-direction: column !important;
                gap: 8px !important;
                padding: 8px !important;
            }

            .student-controls {
                justify-content: center !important;
                flex-wrap: wrap !important;
            }

            .btn-primary,
            .btn-edit {
                padding: 10px 12px !important;
                font-size: 14px !important;
            }

            .stats-block {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 6px !important;
                padding: 8px !important;
                margin: 0 8px !important;
            }

            .stat-item {
                min-width: auto !important;
                padding: 8px 4px !important;
                border-radius: 6px !important;
            }

            .stat-value {
                font-size: 1em !important;
            }

            .stat-label {
                font-size: 0.7em !important;
                line-height: 1.1 !important;
            }

            .schedule {
                display: block !important;
                margin: 8px !important;
                border-radius: 5px !important;
                background: transparent !important;
            }

            .day-header {
                display: none !important;
            }

            .day-column {
                display: block !important;
                background: #f8f9fa !important;
                margin-bottom: 12px !important;
                padding: 8px !important;
                border-radius: 8px !important;
                border: 1px solid #dee2e6 !important;
                min-height: auto !important;
            }

            .day-column::before {
                content: attr(data-day-name) !important;
                display: block !important;
                background: #495057 !important;
                color: white !important;
                padding: 8px !important;
                margin: -8px -8px 8px -8px !important;
                border-radius: 8px 8px 0 0 !important;
                font-weight: 700 !important;
                text-align: center !important;
            }

            .day-column[data-day="1"]::before {
                content: "Pazartesi" !important;
            }

            .day-column[data-day="2"]::before {
                content: "Salı" !important;
            }

            .day-column[data-day="3"]::before {
                content: "Çarşamba" !important;
            }

            .day-column[data-day="4"]::before {
                content: "Perşembe" !important;
            }

            .day-column[data-day="5"]::before {
                content: "Cuma" !important;
            }

            .day-column[data-day="6"]::before {
                content: "Cumartesi" !important;
            }

            .day-column[data-day="0"]::before {
                content: "Pazar" !important;
            }

            .lesson {
                padding: 8px !important;
                margin-bottom: 6px !important;
                background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%) !important;
                border-radius: 6px !important;
                border-left: 4px solid #2196F3 !important;
            }

            .lesson-time {
                font-size: 0.9em !important;
                font-weight: 700 !important;
                color: #1976D2 !important;
            }

            .lesson-student {
                font-size: 1em !important;
                margin: 4px 0 !important;
                font-weight: 600 !important;
            }
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #3c5b73;
            /* mor yerine tek renk yeşil */
            min-height: 100vh;
            padding: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
                font-size: 14px;
            }
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
        }

        .header {
            background: white;
            /* yeşilden beyaza */
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-text {
            text-align: center;
        }

        .header h1 {
            font-size: 3em;
            /* biraz büyütelim */
            margin-bottom: 6px;
            color: #333;
            /* koyu gri */
        }

        .header p {
            font-size: 1.7em;
            color: #555;
            /* koyu gri */
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 1em;
            }

            .header {
                padding: 15px;
                flex-direction: column;
                text-align: center;
            }

            .header .logo {
                max-height: 80px;
                margin-bottom: 5px;
            }
        }

        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 14px 18px;
            border-bottom: 1px solid #ececec;
        }

        .student-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .btn-edit {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 175, 80, 0.2);
        }

        .btn-danger {
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
        }

        .btn-edit {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 10px 12px;
            border-radius: 6px;
        }

        .stats-block {
            display: flex;
            gap: 18px;
            padding: 18px;
            align-items: center;
        }

        @media (max-width: 768px) {
            .stats-block {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 8px !important;
                padding: 8px !important;
                justify-content: stretch !important;
            }
        }

        .stat-item {
            text-align: center;
            padding: 14px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            cursor: default;
            min-width: 160px;
        }

        @media (max-width: 768px) {
            .stat-item {
                min-width: auto !important;
                padding: 8px !important;
                border-radius: 6px;
            }

            .stat-value {
                font-size: 1.1em !important;
            }

            .stat-label {
                font-size: 0.75em !important;
                line-height: 1.2;
            }
        }

        .stat-item.clickable {
            cursor: pointer;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 6px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #4CAF50;
        }

        /* schedule */
        .schedule {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            margin: 18px;
            border-radius: 10px;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .schedule {
                margin: 8px;
                border-radius: 5px;
            }

            .day-header {
                padding: 8px 4px;
                font-size: 0.9em;
            }

            .day-column {
                min-height: 150px;
                padding: 6px;
            }

            .lesson {
                padding: 6px;
                margin-bottom: 4px;
            }

            .lesson-time {
                font-size: 0.8em;
            }

            .lesson-student {
                font-size: 0.9em;
            }
        }

        .day-header {
            background: #495057;
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 700;
        }

        .day-column {
            background: white;
            min-height: 220px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .lesson {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 8px;
            padding: 8px;
            border-left: 4px solid #2196F3;
            cursor: pointer;
            transition: all .18s ease;
        }

        .lesson:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        }

        .lesson-time {
            font-weight: 700;
            color: #1976D2;
            font-size: 0.9em;
        }

        .lesson-student {
            margin: 6px 0;
            font-weight: 600;
        }

        /* modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.45);
        }

        .modal-content {
            background: white;
            margin: 4% auto;
            padding: 20px;
            border-radius: 12px;
            width: 92%;
            max-width: 760px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .close {
            font-size: 22px;
            cursor: pointer;
            color: #888;
        }

        .close:hover {
            color: #444;
        }

        .form-group {
            margin: 12px 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #444;
        }

        .day-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .day-checkbox {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #e6e6e6;
            cursor: pointer;
        }

        .day-checkbox.selected {
            background: #e8f5e8;
            border-color: #4CAF50;
        }

        /* --- Compact time inputs (küçültüldü) --- */
        .time-input-row {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #f0f0f0;
        }

        .time-input-row label {
            margin: 0;
            font-weight: 600;
            white-space: nowrap;
        }


        .time-number {
            padding: 6px 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            width: 10ch;
            /* 3 yerine 5 yap → daha geniş */
        }



        .time-sep {
            text-align: center;
            font-weight: 700;
            color: #6c757d;
            font-size: 18px;
        }

        /* lesson history */
        .lesson-history {
            max-height: 320px;
            overflow: auto;
            border: 1px solid #eee;
            padding: 8px;
            border-radius: 8px;
            background: #fafafa;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }

        .history-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
            min-width: fit-content;
        }

        .btn-small {
            padding: 6px 10px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            background: #4CAF50;
            color: white;
            font-size: 13px;
        }

        .paid {
            background: #4CAF50;
            color: white;
        }

        .unpaid {
            background: #f44336;
            color: white;
        }

        .student-list {
            display: grid;
            gap: 8px;
        }

        .student-card {
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .backup-controls {
            background: #f8f9fa;
            padding: 14px 18px;
            margin: 0 18px 18px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e9e9e9;
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
        }

        @media (max-width:900px) {
            .schedule {
                grid-template-columns: 1fr;
                margin: 12px;
            }

            .stats-block {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                gap: 12px;
                padding: 12px;
            }

            .backup-controls {
                flex-direction: column;
                gap: 8px;
            }

            .top-controls {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }

            .student-controls {
                justify-content: center;
            }

            .btn-primary,
            .btn-edit {
                padding: 12px 16px;
                font-size: 16px;
            }

            .stat-item {
                min-width: auto;
                padding: 12px;
            }

            .stat-value {
                font-size: 1.2em;
            }

            .stat-label {
                font-size: 0.8em;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="Logo" class="logo">
            <div class="header-text">
                <h1>Cavit Çetin ÖZTÜRK</h1>
                <p>Özel Ders Takip Sistemi</p>
            </div>
            <div></div>
        </div>


        <div class="top-controls">
            <div class="student-controls">
                <button class="btn-primary" onclick="openAddStudentModal()">👨‍🎓 Öğrenci Ekle</button>
                <button class="btn-edit" onclick="openEditStudentModal()">🖊️ Öğrenci Düzenle</button>
            </div>

            <div style="display:flex; gap:14px; align-items:center;">
                <div style="text-align:center; cursor:pointer;" onclick="openTotalLessonsModal()">
                    <div id="totalPrivateLessons" style="font-size:1.4em; font-weight:800; color:#4CAF50;">0</div>
                    <div style="font-weight:700; color:#495057;">Toplam Özel Ders</div>

                </div>

                <div id="totalStudentsBox" style="text-align:center; cursor:pointer;" onclick="openStudentListModal()">
                    <div class="student-count" id="totalStudents"
                        style="font-size:1.4em; font-weight:800; color:#1976D2;">0</div>
                    <div class="student-label" style="font-weight:700; color:#495057;">Toplam Öğrenci</div>
                </div>
            </div>
        </div>

        <div class="schedule" id="scheduleGrid">
            <div class="day-header">Pazartesi</div>
            <div class="day-header">Salı</div>
            <div class="day-header">Çarşamba</div>
            <div class="day-header">Perşembe</div>
            <div class="day-header">Cuma</div>
            <div class="day-header">Cumartesi</div>
            <div class="day-header">Pazar</div>

            <div class="day-column" data-day="1"></div>
            <div class="day-column" data-day="2"></div>
            <div class="day-column" data-day="3"></div>
            <div class="day-column" data-day="4"></div>
            <div class="day-column" data-day="5"></div>
            <div class="day-column" data-day="6"></div>
            <div class="day-column" data-day="0"></div>
        </div>

        <div class="stats-block" style="padding:18px; justify-content:center;">
            <div class="stat-item stat-item-clickable clickable" onclick="openStatsDetail('weekly')">
                <div class="stat-value" id="weeklyEarnings">₺0</div>
                <div class="stat-label">Bu Haftaki Kazanç</div>
            </div>

            <div class="stat-item stat-item-clickable clickable" onclick="openStatsDetail('monthly')">
                <div class="stat-value" id="monthlyEarnings">₺0</div>
                <div class="stat-label">Bu Ayki Kazanç</div>
            </div>

            <div class="stat-item stat-item-clickable clickable" onclick="openStatsDetail('pending')">
                <div class="stat-value" id="pendingPayments">₺0</div>
                <div class="stat-label">Yapılmamış Ödemeler</div>
            </div>

            <div class="stat-item" title="Bu ay programlı tüm derslerin gerçekleştirilmesi halinde beklenen gelir">
                <div class="stat-value" id="potentialMonthly">₺0</div>
                <div class="stat-label">Potansiyel Aylık Gelir</div>
            </div>

            <div class="stat-item stat-item-clickable clickable" onclick="openHistoryModal()">
                <div class="stat-value">📅</div>
                <div class="stat-label">Geçmiş Aylık Raporlar</div>
            </div>
        </div>


        <div class="backup-controls">
            <div style="display:flex; gap:8px; align-items:center;">
                <div>
                    <button onclick="exportData()" class="btn-primary" style="padding:8px 12px;">📥 Kaydet</button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
                    <button onclick="document.getElementById('importFile').click()" class="btn-primary"
                        style="background:#28a745; margin-left:8px; padding:8px 12px;">📤 Yükle</button>
                </div>
            </div>

            <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn-danger" onclick="clearAllData()">💣 Her Şeyi Sil</button>
            </div>
        </div>
    </div>

    <!-- ADD STUDENT MODAL -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👨‍🎓 Yeni Öğrenci Ekle</h2>
                <span class="close" onclick="closeModal('addStudentModal')">×</span>
            </div>

            <form id="studentForm">
                <div class="form-group">
                    <label>Öğrenci Adı</label>
                    <input id="studentName" type="text" required
                        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                </div>

                <div class="form-group">
                    <label>Ders Ücreti (₺)</label>
                    <input id="lessonFee" type="number" min="0" step="0.01" required
                        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                </div>

                <div class="form-group">
                    <label>Ders Günleri</label>
                    <div class="day-select" id="addDaySelect">
                        <div class="day-checkbox" onclick="toggleDay(1,this)"><input type="checkbox"
                                style="display:none" value="1"> Pazartesi</div>
                        <div class="day-checkbox" onclick="toggleDay(2,this)"><input type="checkbox"
                                style="display:none" value="2"> Salı</div>
                        <div class="day-checkbox" onclick="toggleDay(3,this)"><input type="checkbox"
                                style="display:none" value="3"> Çarşamba</div>
                        <div class="day-checkbox" onclick="toggleDay(4,this)"><input type="checkbox"
                                style="display:none" value="4"> Perşembe</div>
                        <div class="day-checkbox" onclick="toggleDay(5,this)"><input type="checkbox"
                                style="display:none" value="5"> Cuma</div>
                        <div class="day-checkbox" onclick="toggleDay(6,this)"><input type="checkbox"
                                style="display:none" value="6"> Cumartesi</div>
                        <div class="day-checkbox" onclick="toggleDay(0,this)"><input type="checkbox"
                                style="display:none" value="0"> Pazar</div>
                    </div>
                </div>

                <div id="timeInputsContainer"></div>

                <div style="text-align:right; margin-top:12px;">
                    <button type="submit" class="btn-primary">Öğrenciyi Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EDIT STUDENT MODAL -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏ Öğrenci Düzenle</h2>
                <span class="close" onclick="closeModal('editStudentModal')">×</span>
            </div>

            <div class="form-group">
                <label>Düzenlenecek Öğrenci</label>
                <select id="studentToEdit" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"
                    onchange="loadStudentForEdit()">
                    <option value="">Öğrenci Seçin</option>
                </select>
            </div>

            <form id="editStudentForm" style="display:none;">
                <div class="form-group">
                    <label>Öğrenci Adı</label>
                    <input id="editStudentName" type="text" required
                        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                </div>

                <div class="form-group">
                    <label>Ders Ücreti (₺)</label>
                    <input id="editLessonFee" type="number" min="0" step="0.01" required
                        style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;">
                </div>

                <div class="form-group">
                    <label>Ders Günleri</label>
                    <div class="day-select" id="editDaySelect">
                        <div class="day-checkbox" onclick="toggleEditDay(1,this)"><input type="checkbox"
                                style="display:none" value="1"> Pazartesi</div>
                        <div class="day-checkbox" onclick="toggleEditDay(2,this)"><input type="checkbox"
                                style="display:none" value="2"> Salı</div>
                        <div class="day-checkbox" onclick="toggleEditDay(3,this)"><input type="checkbox"
                                style="display:none" value="3"> Çarşamba</div>
                        <div class="day-checkbox" onclick="toggleEditDay(4,this)"><input type="checkbox"
                                style="display:none" value="4"> Perşembe</div>
                        <div class="day-checkbox" onclick="toggleEditDay(5,this)"><input type="checkbox"
                                style="display:none" value="5"> Cuma</div>
                        <div class="day-checkbox" onclick="toggleEditDay(6,this)"><input type="checkbox"
                                style="display:none" value="6"> Cumartesi</div>
                        <div class="day-checkbox" onclick="toggleEditDay(0,this)"><input type="checkbox"
                                style="display:none" value="0"> Pazar</div>
                    </div>
                </div>

                <div id="editTimeInputsContainer"></div>

                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <button type="button" class="btn-danger" onclick="deleteCurrentStudent()">🗑 Öğrenciyi Sil</button>
                    <button type="submit" class="btn-primary">Değişiklikleri Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- REMOVE STUDENT MODAL -->
    <div id="removeStudentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🗑 Öğrenci Çıkar</h2>
                <span class="close" onclick="closeModal('removeStudentModal')">×</span>
            </div>

            <div class="form-group">
                <label>Çıkarılacak Öğrenci</label>
                <select id="studentToRemove"
                    style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd;"></select>
            </div>

            <div style="text-align:right;">
                <button class="btn-danger" onclick="removeStudent()">Öğrenciyi Çıkar</button>
            </div>
        </div>
    </div>

    <!-- STUDENT DETAIL / LESSON HISTORY MODAL -->
    <div id="studentDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="studentDetailTitle">Öğrenci Detayları</h2>
                <span class="close" onclick="closeModal('studentDetailModal')">×</span>
            </div>

            <div style="margin-bottom:10px;">
                <div><strong>Son işlenen konu:</strong> <span id="lastTopicDisplay">-</span></div>
                <div><strong>Sıradaki konu:</strong> <span id="nextTopicDisplay">-</span></div>
                <div><strong>Ders Ücreti:</strong> <span id="studentFeeAmount">₺0.00</span></div>
            </div>

            <div class="form-group">
                <label>Ders Tarihi</label>
                <select id="lessonDate"
                    style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;"></select>
            </div>

            <div class="form-group">
                <label>Ödeme Durumu</label>
                <select id="paymentReceived" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;">
                    <option value="true">Ödendi</option>
                    <option value="false">Ödenmedi</option>
                </select>
            </div>

            <div class="form-group">
                <label>İşlenen konu</label>
                <input id="currentTopicInput" type="text" placeholder="Bu derste hangi konu işlendi?"
                    style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;">
            </div>

            <div class="form-group">
                <label>Sonraki derste işlenecek konu</label>
                <input id="nextTopicInput" type="text" placeholder="Sonraki derste hangi konu işlenecek?"
                    style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;">
            </div>

            <div style="text-align:right;"><button class="btn-primary" onclick="addLessonRecord()">Ders Kaydı
                    Ekle</button></div>

            <div style="margin-top:18px;">
                <h3>📅 Ders Geçmişi</h3>
                <div id="lessonHistory" class="lesson-history"></div>
            </div>
        </div>
    </div>

    <!-- EDIT LESSON MODAL -->
    <div id="editLessonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏ Ders Kaydını Düzenle</h2>
                <span class="close" onclick="closeModal('editLessonModal')">×</span>
            </div>
            <div class="form-group">
                <label>Ders Tarihi</label>
                <select id="editLessonDateSelect"
                    style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;"></select>
            </div>
            <div class="form-group">
                <label>Ödeme Durumu</label>
                <select id="editPaymentStatus"
                    style="width:100%; padding:8px; border-radius:6px; border:1px solid #ddd;">
                    <option value="false">Ödenmedi</option>
                    <option value="true">Ödendi</option>
                </select>
            </div>

            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button class="btn-primary" onclick="updateLessonRecord()">Değişiklikleri Kaydet</button>
                <button class="btn-danger" onclick="deleteLessonRecordFromModal()">Ders Kaydını Sil</button>
            </div>
        </div>
    </div>

    <!-- STATS DETAIL MODAL (weekly/monthly/pending list) -->
    <div id="statsDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="statsDetailTitle">Ayrıntılar</h2>
                <span class="close" onclick="closeModal('statsDetailModal')">×</span>
            </div>

            <div id="statsDetailList" class="lesson-history"></div>
        </div>
    </div>

    <!-- STUDENT LIST MODAL -->
    <div id="studentListModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👥 Öğrenci Listesi</h2>
                <span class="close" onclick="closeModal('studentListModal')">×</span>
            </div>
            <div id="studentListContainer" class="student-list"></div>
        </div>
    </div>

    <!-- TOTAL LESSONS DETAILS MODAL -->
    <div id="totalLessonsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📚 Toplam Özel Ders Detayları</h2>
                <span class="close" onclick="closeModal('totalLessonsModal')">×</span>
            </div>
            <div id="totalLessonsList" class="lesson-history"></div>
        </div>
    </div>

    <!-- HISTORY MODAL -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🕘 Geçmiş Aylık Raporlar</h2>
                <span class="close" onclick="closeModal('historyModal')">×</span>
            </div>
            <div id="historyList" class="lesson-history"></div>
        </div>
    </div>

    <script>
        /* ======== Veri ve başlangıç ======== */
        let students = JSON.parse(localStorage.getItem('students') || '[]');
        let lessonRecords = JSON.parse(localStorage.getItem('lessonRecords') || '[]');

        let selectedDays = [];         // add modal (days selected)
        let selectedEditDays = [];     // edit modal
        let currentEditingStudent = null;
        let currentStudentNameForDetail = null;
        let currentEditingLesson = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderSchedule();
            updateStats();
            updateStudentCount();
            updateTotalPrivateLessons();
        });

        /* ======== Yardımcı: modal kontrol ======== */
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        /* ======== GÜN seçimi (ADD) ======== */
        function toggleDay(dayIndex, el) {
            const chk = el.querySelector('input[type="checkbox"]');
            chk.checked = !chk.checked;
            if (chk.checked) {
                el.classList.add('selected');
                if (!selectedDays.includes(dayIndex)) selectedDays.push(dayIndex);
            } else {
                el.classList.remove('selected');
                selectedDays = selectedDays.filter(d => d !== dayIndex);
            }
            updateAddTimeInputs();
        }

        /* ======== GÜN seçimi (EDIT) ======== */
        function toggleEditDay(dayIndex, el) {
            const chk = el.querySelector('input[type="checkbox"]');
            chk.checked = !chk.checked;
            if (chk.checked) {
                el.classList.add('selected');
                if (!selectedEditDays.includes(dayIndex)) selectedEditDays.push(dayIndex);
            } else {
                el.classList.remove('selected');
                selectedEditDays = selectedEditDays.filter(d => d !== dayIndex);
            }
            updateEditTimeInputsPreserveValues();
        }

        /* ======== Zaman inputları (ADD) - oluşturma (küçük kutular) ======== */
        function updateAddTimeInputs() {
            const container = document.getElementById('timeInputsContainer');

            // önceki girilmiş değerleri al
            const existing = {};
            container.querySelectorAll('input').forEach(inp => {
                const id = inp.id; // örn: hour_add_1
                const parts = id.split('_'); // ["hour","add","1"]
                const kind = parts[0];
                const day = parseInt(parts[2]);
                existing[day] = existing[day] || {};
                if (kind === 'hour') existing[day].hour = inp.value;
                if (kind === 'minute') existing[day].minute = inp.value;
            });

            container.innerHTML = '';
            const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            selectedDays.sort((a, b) => a - b);
            selectedDays.forEach(day => {
                const row = document.createElement('div');
                row.className = 'time-input-row';
                row.innerHTML = `
            <label>${dayNames[day]} Ders Saati</label>
            <input type="number" min="0" max="23" id="hour_add_${day}" class="time-number" placeholder="Saat" required>
            <div class="time-sep">:</div>
            <input type="number" min="0" max="59" id="minute_add_${day}" class="time-number" placeholder="Dakika" required>
        `;
                container.appendChild(row);

                const hourInput = row.querySelector(`#hour_add_${day}`);
                const minuteInput = row.querySelector(`#minute_add_${day}`);

                // eski değerleri geri yükle
                if (existing[day]) {
                    if (existing[day].hour !== undefined) hourInput.value = existing[day].hour;
                    if (existing[day].minute !== undefined) minuteInput.value = existing[day].minute;
                }

                hourInput.addEventListener('input', function () {
                    if (this.value.length >= 2 || parseInt(this.value) > 2) minuteInput.focus();
                });
            });
        }


        /* ======== Zaman inputları (EDIT) - değerleri koruyarak yeniden oluşturma ======== */
        function updateEditTimeInputsPreserveValues() {
            const container = document.getElementById('editTimeInputsContainer');
            // önceden girilmiş değerleri al
            const existing = {};
            container.querySelectorAll('input').forEach(inp => {
                const id = inp.id;
                // id örn: edit_hour_2 veya edit_minute_2
                const parts = id.split('_');
                const kind = parts[1]; // hour / minute
                const day = parseInt(parts[2]);
                existing[day] = existing[day] || { hour: '', minute: '' };
                if (kind === 'hour') existing[day].hour = inp.value;
                if (kind === 'minute') existing[day].minute = inp.value;
            });

            container.innerHTML = '';
            const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            selectedEditDays.sort((a, b) => a - b);
            selectedEditDays.forEach(day => {
                const row = document.createElement('div');
                row.className = 'time-input-row';
                row.innerHTML = `
            <label>${dayNames[day]} Ders Saati</label>
            <input type="number" min="0" max="23" id="edit_hour_${day}" class="time-number" placeholder="Saat" required>
            <div class="time-sep">:</div>
            <input type="number" min="0" max="59" id="edit_minute_${day}" class="time-number" placeholder="Dakika" required>
        `;
                container.appendChild(row);

                const hourInput = row.querySelector(`#edit_hour_${day}`);
                const minuteInput = row.querySelector(`#edit_minute_${day}`);
                // varsa eski değerleri tekrar set et
                if (existing[day]) {
                    if (existing[day].hour !== undefined) hourInput.value = existing[day].hour;
                    if (existing[day].minute !== undefined) minuteInput.value = existing[day].minute;
                }

                hourInput.addEventListener('input', function () { if (this.value.length >= 2 || parseInt(this.value) > 2) minuteInput.focus(); });
            });
        }

        /* ======== Öğrenci ekleme aç/kapa ======== */
        function openAddStudentModal() {
            document.getElementById('studentForm').reset();
            selectedDays = [];
            resetDayCheckboxes('#addDaySelect');
            updateAddTimeInputs();
            openModal('addStudentModal');
        }

        /* ======== Öğrenci düzenleme aç ======== */
        function openEditStudentModal() {
            populateEditStudentSelect();
            selectedEditDays = [];
            resetDayCheckboxes('#editDaySelect');
            updateEditTimeInputsPreserveValues();
            openModal('editStudentModal');
        }

        /* ======== Öğrenci silme modal aç ======== */
        function openRemoveStudentModal() {
            populateRemoveStudentSelect();
            openModal('removeStudentModal');
        }

        /* ======== Checkbox sıfırlama yardımcı ======== */
        function resetDayCheckboxes(selector) {
            document.querySelectorAll(selector + ' .day-checkbox').forEach(el => {
                el.classList.remove('selected');
                const input = el.querySelector('input[type="checkbox"]');
                if (input) input.checked = false;
            });
        }

        /* ======== Öğrenciyi ekle (form submit) ======== */
        document.getElementById('studentForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const name = document.getElementById('studentName').value.trim();
            const fee = parseFloat(document.getElementById('lessonFee').value);
            if (!name) return;
            if (students.some(s => s.name === name)) {
                alert('Bu isimde bir öğrenci zaten mevcut!');
                return;
            }
            const schedule = [];
            selectedDays.forEach(day => {
                const h = document.getElementById(`hour_add_${day}`);
                const m = document.getElementById(`minute_add_${day}`);
                if (h && m && h.value !== '' && m.value !== '') {
                    const hour = String(h.value).padStart(2, '0');
                    const minute = String(m.value).padStart(2, '0');
                    schedule.push({ day: day, time: `${hour}:${minute}` });
                }
            });
            if (schedule.length === 0) {
                alert('En az bir gün ve saat seçmelisiniz!');
                return;
            }
            const newStudent = { id: Date.now(), name, fee: fee || 0, schedule, lastTopic: '', nextTopic: '' };
            students.push(newStudent);
            saveStudents();
            renderSchedule();
            updateStudentCount();
            updateStats();
            updateTotalPrivateLessons();
            closeModal('addStudentModal');
            // success alert removed by request
        });

        /* ======== Edit: select doldurma ve yükleme ======== */
        function populateEditStudentSelect() {
            const sel = document.getElementById('studentToEdit');
            sel.innerHTML = '<option value="">Öğrenci Seçin</option>';
            students.forEach(s => {
                const o = document.createElement('option');
                o.value = s.name;
                o.textContent = s.name;
                sel.appendChild(o);
            });
        }

        function loadStudentForEdit() {
            const name = document.getElementById('studentToEdit').value;
            if (!name) { document.getElementById('editStudentForm').style.display = 'none'; return; }
            const student = students.find(s => s.name === name);
            if (!student) return;
            currentEditingStudent = name;
            document.getElementById('editStudentName').value = student.name;
            document.getElementById('editLessonFee').value = student.fee;
            // reset
            selectedEditDays = [];
            resetDayCheckboxes('#editDaySelect');
            // load schedule days
            student.schedule.forEach(sch => {
                if (!selectedEditDays.includes(sch.day)) selectedEditDays.push(sch.day);
                const idx = sch.day; // find corresponding checkbox
                const dayCheckbox = document.querySelector(`#editDaySelect .day-checkbox:nth-child(${getIndexForEditDay(idx)})`);
                // instead of nth-child (which depends on layout), mark by text match
                // simpler: loop to find day-checkbox with innerText containing name index -> We'll just mark all and rely on day values stored in selectedEditDays
            });
            // mark checkbox elements based on selectedEditDays
            document.querySelectorAll('#editDaySelect .day-checkbox').forEach(el => {
                const txt = el.textContent.trim();
                const dayMap = { 'Pazartesi': 1, 'Salı': 2, 'Çarşamba': 3, 'Perşembe': 4, 'Cuma': 5, 'Cumartesi': 6, 'Pazar': 0 };
                const day = dayMap[txt];
                if (selectedEditDays.includes(day)) {
                    el.classList.add('selected');
                    const ch = el.querySelector('input[type="checkbox"]');
                    if (ch) ch.checked = true;
                } else {
                    el.classList.remove('selected');
                    const ch = el.querySelector('input[type="checkbox"]');
                    if (ch) ch.checked = false;
                }
            });

            // oluştur ve değerleri set et (kull. updateEditTimeInputsPreserveValues ile)
            updateEditTimeInputsPreserveValues();

            // populate values after small delay to ensure inputs are created
            setTimeout(() => {
                student.schedule.forEach(sch => {
                    const [hour, minute] = sch.time.split(':');
                    const h = document.getElementById(`edit_hour_${sch.day}`);
                    const m = document.getElementById(`edit_minute_${sch.day}`);
                    if (h) h.value = parseInt(hour, 10);
                    if (m) m.value = parseInt(minute, 10);
                });
            }, 80);

            document.getElementById('editStudentForm').style.display = 'block';
        }

        /* helper to map day index to nth-child order inside editDaySelect (we used explicit order in HTML) */
        function getIndexForEditDay(day) {
            // HTML order: Pazartesi (1), Salı (2), Çarşamba (3), Perşembe (4), Cuma (5), Cumartesi (6), Pazar (0) => mapping:
            if (day === 1) return 1;
            if (day === 2) return 2;
            if (day === 3) return 3;
            if (day === 4) return 4;
            if (day === 5) return 5;
            if (day === 6) return 6;
            if (day === 0) return 7;
            return 1;
        }

        /* ======== Öğrenci düzenleme submit ======== */
        /* ======== Öğrenci silme (edit modal'dan) ======== */
        function deleteCurrentStudent() {
            if (!currentEditingStudent) {
                alert('Silinecek öğrenci bulunamadı!');
                return;
            }

            const student = students.find(s => s.name === currentEditingStudent);
            if (!student) return;

            const lessonCount = lessonRecords.filter(r => r.studentName === currentEditingStudent).length;
            const confirmMsg = `${currentEditingStudent} adlı öğrenciyi silmek istediğinize emin misiniz?\n\n` +
                `• Öğrenci tamamen silinecek\n` +
                `• ${lessonCount} ders kaydı silinecek\n` +
                `• Bu işlem geri alınamaz!`;

            if (confirm(confirmMsg)) {
                students = students.filter(s => s.name !== currentEditingStudent);
                lessonRecords = lessonRecords.filter(r => r.studentName !== currentEditingStudent);
                saveStudents();
                saveLessonRecords();
                renderSchedule();
                updateStats();
                updateStudentCount();
                updateTotalPrivateLessons();
                closeModal('editStudentModal');
            }
        }
        document.getElementById('editStudentForm').addEventListener('submit', function (e) {
            e.preventDefault();
            const newName = document.getElementById('editStudentName').value.trim();
            const fee = parseFloat(document.getElementById('editLessonFee').value);
            if (!newName) return;
            if (newName !== currentEditingStudent && students.some(s => s.name === newName)) {
                alert('Bu isimde bir öğrenci zaten mevcut!');
                return;
            }
            const schedule = [];
            selectedEditDays.forEach(day => {
                const h = document.getElementById(`edit_hour_${day}`);
                const m = document.getElementById(`edit_minute_${day}`);
                if (h && m && h.value !== '' && m.value !== '') {
                    const hour = String(h.value).padStart(2, '0');
                    const minute = String(m.value).padStart(2, '0');
                    schedule.push({ day: day, time: `${hour}:${minute}` });
                }
            });
            if (schedule.length === 0) {
                alert('En az bir gün ve saat seçmelisiniz!');
                return;
            }
            const idx = students.findIndex(s => s.name === currentEditingStudent);
            if (idx !== -1) {
                const oldName = students[idx].name;
                students[idx] = { id: students[idx].id, name: newName, fee: fee || 0, schedule, lastTopic: students[idx].lastTopic || '', nextTopic: students[idx].nextTopic || '' };
                // update lesson records student name if changed
                if (newName !== oldName) {
                    lessonRecords.forEach(rec => {
                        if (rec.studentName === oldName) rec.studentName = newName;
                    });
                    saveLessonRecords();
                }
                saveStudents();
                renderSchedule();
                updateStats();
                updateStudentCount();
                updateTotalPrivateLessons();
                closeModal('editStudentModal');
                // success alert removed
            }
        });

        /* ======== Öğrenci çıkarma ve select doldurma ======== */
        function populateRemoveStudentSelect() {
            const sel = document.getElementById('studentToRemove');
            sel.innerHTML = '<option value="">Öğrenci Seçin</option>';
            students.forEach(s => {
                const o = document.createElement('option'); o.value = s.name; o.textContent = s.name; sel.appendChild(o);
            });
        }

        function removeStudent() {
            const sel = document.getElementById('studentToRemove');
            const name = sel.value;
            if (!name) { alert('Lütfen bir öğrenci seçin!'); return; }
            if (confirm(`${name} adlı öğrenciyi ve tüm ders kayıtlarını silmek istediğinize emin misiniz?`)) {
                students = students.filter(s => s.name !== name);
                lessonRecords = lessonRecords.filter(r => r.studentName !== name);
                saveStudents();
                saveLessonRecords();
                renderSchedule();
                updateStats();
                updateStudentCount();
                updateTotalPrivateLessons();
                closeModal('removeStudentModal');
                // success alert removed
            }
        }

        /* ======== Schedule render (gün sütunları ve dersler) ======== */
        function renderSchedule() {
            // day columns are 1..6,0 ordering; we used data-day attributes accordingly
            document.querySelectorAll('.day-column').forEach(col => {
                const day = parseInt(col.getAttribute('data-day'));
                col.innerHTML = '';
                const dayLessons = [];
                students.forEach(s => {
                    const sch = s.schedule.find(x => x.day === day);
                    if (sch) dayLessons.push({ studentName: s.name, time: sch.time, fee: s.fee });
                });
                dayLessons.sort((a, b) => a.time.localeCompare(b.time));
                dayLessons.forEach(l => {
                    const div = document.createElement('div'); div.className = 'lesson';
                    div.innerHTML = `<div class="lesson-time">${l.time}</div><div class="lesson-student">${l.studentName}</div><div style="font-weight:700; color:#4CAF50;">₺${(l.fee || 0).toFixed(0)}</div>`;
                    div.onclick = () => openStudentDetailModal(l.studentName);
                    col.appendChild(div);
                });
            });
        }

        /* ======== STUDENT DETAIL MODAL ve Ders tarihi doldurma ======== */
        function openStudentDetailModal(studentName) {
            currentStudentNameForDetail = studentName;
            const student = students.find(s => s.name === studentName);
            if (!student) return;
            document.getElementById('studentDetailTitle').textContent = studentName;
            document.getElementById('studentFeeAmount').textContent = `₺${(student.fee || 0).toFixed(0)}`;
            const records = lessonRecords.filter(r => r.studentName === studentName);
            document.getElementById('lastTopicDisplay').textContent = student.lastTopic || '-';
            document.getElementById('nextTopicDisplay').textContent = student.nextTopic || '-';

            populateLessonDates(student);
            renderLessonHistory(studentName);
            openModal('studentDetailModal');
        }

        /* populateLessonDates: 1 hafta öncesinden 2026 Haziran sonuna kadar öğrenci programlanan tarihler */
        function populateLessonDates(student) {
            const sel = document.getElementById('lessonDate');
            sel.innerHTML = '<option value="">Tarih Seçin</option>';

            const today = new Date();
            const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            const studentDays = student.schedule.map(s => s.day);

            // 2 hafta öncesinden başla
            const startDate = new Date(today);
            startDate.setDate(today.getDate() - 14);

            // 2026 Haziran son günü
            const endDate = new Date(2026, 5, 30); // Month is 0-indexed, so 5 = June

            // Tarih aralığını gün gün iterasyon yap
            for (let currentDate = new Date(startDate); currentDate <= endDate; currentDate.setDate(currentDate.getDate() + 1)) {
                const curDayOfWeek = currentDate.getDay(); // 0..6 (Pazar..Cumartesi)

                // Sadece öğrencinin ders günlerini dahil et
                if (studentDays.includes(curDayOfWeek)) {
                    const dateStr = currentDate.getFullYear() + '-' +
                        String(currentDate.getMonth() + 1).padStart(2, '0') + '-' +
                        String(currentDate.getDate()).padStart(2, '0');
                    const display = currentDate.toLocaleDateString('tr-TR') + ' (' + dayNames[currentDate.getDay()] + ')';
                    const o = document.createElement('option');
                    o.value = dateStr;
                    o.textContent = display;
                    sel.appendChild(o);
                }
            }
        }

        /* ======== Ders kaydı ekleme ======== */
        function addLessonRecord() {
            const student = students.find(s => s.name === currentStudentNameForDetail);
            if (!student) return;
            const lessonDate = document.getElementById('lessonDate').value;
            const paymentReceived = document.getElementById('paymentReceived').value === 'true';
            if (!lessonDate) { alert('Lütfen ders tarihi seçin!'); return; }
            const existing = lessonRecords.find(r => r.studentName === currentStudentNameForDetail && r.date === lessonDate);
            if (existing) { alert('Bu tarihte zaten bir ders kaydı bulunuyor!'); return; }
            const currentTopic = document.getElementById('currentTopicInput').value.trim();
            const nextTopic = document.getElementById('nextTopicInput').value.trim();

            const newRec = { id: Date.now(), studentName: currentStudentNameForDetail, date: lessonDate, fee: student.fee || 0, paid: paymentReceived };
            lessonRecords.push(newRec);

            // Öğrencinin konu bilgilerini güncelle
            if (currentTopic) student.lastTopic = currentTopic;
            if (nextTopic) student.nextTopic = nextTopic;
            saveStudents();

            // Ekrandaki konu bilgilerini güncelle
            document.getElementById('lastTopicDisplay').textContent = student.lastTopic || '-';
            document.getElementById('nextTopicDisplay').textContent = student.nextTopic || '-';

            // Input alanlarını temizle
            document.getElementById('currentTopicInput').value = '';
            document.getElementById('nextTopicInput').value = '';

            saveLessonRecords();
            renderLessonHistory(currentStudentNameForDetail);
            updateStats();
            closeModal('studentDetailModal'); // optional: close to reduce accidental repeats
            // success alert removed
        }

        /* ======== Ders geçmişi render ======== */
        function renderLessonHistory(studentName) {
            const container = document.getElementById('lessonHistory');
            const records = lessonRecords.filter(r => r.studentName === studentName).sort((a, b) => new Date(b.date) - new Date(a.date));
            container.innerHTML = '';
            if (records.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#6c757d;padding:10px;">Henüz ders kaydı bulunmuyor.</p>';
                return;
            }
            records.forEach(rec => {
                const div = document.createElement('div'); div.className = 'history-item';
                const dateStr = new Date(rec.date).toLocaleDateString('tr-TR');
                div.innerHTML = `<div><strong>📅 ${dateStr}</strong><br><small>₺${rec.fee.toFixed(0)}</small></div>`;
                const actions = document.createElement('div'); actions.className = 'history-actions';
                const payBtn = document.createElement('button'); payBtn.className = 'btn-small ' + (rec.paid ? 'paid' : 'unpaid');
                payBtn.textContent = rec.paid ? '✅ Ödendi' : '❌ Ödenmedi';
                payBtn.onclick = () => { togglePaymentStatus(rec.id); };
                const editBtn = document.createElement('button'); editBtn.className = 'btn-small'; editBtn.textContent = '✏'; editBtn.onclick = () => openEditLessonModal(rec.id);
                const delBtn = document.createElement('button'); delBtn.className = 'btn-small'; delBtn.textContent = '🗑'; delBtn.onclick = () => deleteLessonRecord(rec.id);
                actions.appendChild(payBtn); actions.appendChild(editBtn); actions.appendChild(delBtn);
                div.appendChild(actions);
                container.appendChild(div);
            });
        }

        /* ======== Edit lesson modal ve update/delete ======== */
        function openEditLessonModal(recordId) {
            currentEditingLesson = lessonRecords.find(r => r.id === recordId);
            if (!currentEditingLesson) return;
            const student = students.find(s => s.name === currentEditingLesson.studentName);
            populateEditLessonDates(student, currentEditingLesson);
            document.getElementById('editLessonDateSelect').value = currentEditingLesson.date;
            document.getElementById('editPaymentStatus').value = currentEditingLesson.paid.toString();
            openModal('editLessonModal');
        }

        function populateEditLessonDates(student, currentRecord) {
            const sel = document.getElementById('editLessonDateSelect');
            sel.innerHTML = '';
            const today = new Date();
            const dayNames = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            const studentDays = student.schedule.map(s => s.day);
            const startDate = new Date();
            startDate.setDate(today.getDate() - 84); // geçmiş 12 hafta
            for (let i = 0; i < 168; i++) {
                const cur = new Date(startDate);
                cur.setDate(startDate.getDate() + i);
                const curDay = cur.getDay();
                if (studentDays.includes(curDay)) {
                    const dateStr = cur.toISOString().split('T')[0];
                    const display = cur.toLocaleDateString('tr-TR') + ' (' + dayNames[cur.getDay()] + ')';
                    const o = document.createElement('option'); o.value = dateStr; o.textContent = display;
                    if (dateStr === currentRecord.date) o.selected = true;
                    sel.appendChild(o);
                }
            }
        }

        function updateLessonRecord() {
            if (!currentEditingLesson) return;
            const newDate = document.getElementById('editLessonDateSelect').value;
            const newPaid = document.getElementById('editPaymentStatus').value === 'true';
            if (newDate !== currentEditingLesson.date) {
                const exists = lessonRecords.find(r => r.studentName === currentEditingLesson.studentName && r.date === newDate && r.id !== currentEditingLesson.id);
                if (exists) { alert('Bu tarihte zaten bir ders kaydı bulunuyor!'); return; }
            }
            currentEditingLesson.date = newDate;
            currentEditingLesson.paid = newPaid;
            saveLessonRecords();
            renderLessonHistory(currentEditingLesson.studentName);
            updateStats();
            closeModal('editLessonModal');
            // success alert removed
        }

        function deleteLessonRecordFromModal() {
            if (!currentEditingLesson) return;
            deleteLessonRecord(currentEditingLesson.id);
            closeModal('editLessonModal');
        }

        function deleteLessonRecord(recordId) {
            const rec = lessonRecords.find(r => r.id === recordId);
            if (!rec) return;
            if (confirm(`Ders Kaydını Sil\n\nTarih: ${new Date(rec.date).toLocaleDateString('tr-TR')}\nÖğrenci: ${rec.studentName}\nÜcret: ₺${rec.fee.toFixed(0)}\n\nBu ders kaydını silmek istediğinize emin misiniz?`)) {
                lessonRecords = lessonRecords.filter(r => r.id !== recordId);
                saveLessonRecords();
                if (currentStudentNameForDetail) renderLessonHistory(currentStudentNameForDetail);
                updateStats();
                // success alert removed
            }
        }

        /* ======== Ödeme toggle (history) ======== */
        function togglePaymentStatus(recordId) {
            const rec = lessonRecords.find(r => r.id === recordId);
            if (!rec) return;
            rec.paid = !rec.paid;
            saveLessonRecords();
            if (currentStudentNameForDetail) renderLessonHistory(currentStudentNameForDetail);
            updateStats();
        }

        /* ======== İstatistikler: update ======== */
        function updateStats() {
            const now = new Date();
            // week start: monday
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0..6
            // find monday of current week
            const monday = new Date(today);
            const diff = (dayOfWeek + 6) % 7; // days since monday
            monday.setDate(today.getDate() - diff);
            monday.setHours(0, 0, 0, 0);

            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            monthStart.setHours(0, 0, 0, 0);

            const weeklyEarnings = lessonRecords.filter(r => {
                const d = new Date(r.date);
                return d >= monday && r.paid;
            }).reduce((a, b) => a + b.fee, 0);

            const monthlyEarnings = lessonRecords.filter(r => {
                const d = new Date(r.date);
                return d >= monthStart && r.paid;
            }).reduce((a, b) => a + b.fee, 0);

            const pendingPayments = lessonRecords.filter(r => !r.paid).reduce((a, b) => a + b.fee, 0);

            document.getElementById('weeklyEarnings').textContent = `₺${weeklyEarnings.toFixed(0)}`;
            document.getElementById('monthlyEarnings').textContent = `₺${monthlyEarnings.toFixed(0)}`;
            document.getElementById('pendingPayments').textContent = `₺${pendingPayments.toFixed(0)}`;

            // potential monthly income
            const potential = calculatePotentialMonthlyIncome();
            document.getElementById('potentialMonthly').textContent = `₺${potential.toFixed(0)}`;
        }

        /* ======== Potansiyel aylık gelir hesaplama ========
           Şu ayın 1. günü ile son günü arasındaki öğrenci programlarına göre
           o tarihlerde ders olsaydı alınacak toplam ücret hesaplanır.
        */
        function calculatePotentialMonthlyIncome() {
            const now = new Date();
            const year = now.getFullYear(), month = now.getMonth();
            const start = new Date(year, month, 1);
            const end = new Date(year, month + 1, 0);
            let total = 0;
            // iterate dates of month
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dayIndex = d.getDay(); // 0..6 (Pazar..Cumartesi)
                students.forEach(s => {
                    const sch = s.schedule.find(x => x.day === dayIndex);
                    if (sch) total += (s.fee || 0);
                });
            }
            return total;
        }

        /* ======== Toplam özel ders sayısı (haftalık) ======== */
        function updateTotalPrivateLessons() {
            // toplam haftalık ders sayısı: her öğrencinin haftalık programında kaç gün varsa topla
            let total = 0;
            students.forEach(s => total += (s.schedule ? s.schedule.length : 0));
            document.getElementById('totalPrivateLessons').textContent = total;
        }

        /* ======== Toplam öğrenci sayısı ======== */
        function updateStudentCount() {
            document.getElementById('totalStudents').textContent = students.length;
        }

        /* ======== Veri kaydetme ======== */
        function saveStudents() { localStorage.setItem('students', JSON.stringify(students)); }
        function saveLessonRecords() { localStorage.setItem('lessonRecords', JSON.stringify(lessonRecords)); }

        /* ======== Veri yedekleme / yükleme ======== */
        function exportData() {
            const data = { students, lessonRecords, exportDate: new Date().toISOString(), version: "2.1" };
            const str = JSON.stringify(data, null, 2);
            const blob = new Blob([str], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ders-verileri-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            // success alert removed
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!Array.isArray(data.students) || !Array.isArray(data.lessonRecords)) throw new Error('Geçersiz dosya formatı');
                    if (students.length > 0 || lessonRecords.length > 0) {
                        const confirmReplace = confirm('Mevcut verileriniz silinecek ve yüklenen veriler ile değiştirilecek. Devam edilsin mi?');
                        if (!confirmReplace) { event.target.value = ''; return; }
                    }
                    students = data.students;
                    lessonRecords = data.lessonRecords;
                    saveStudents();
                    saveLessonRecords();
                    renderSchedule();
                    updateStats();
                    updateStudentCount();
                    updateTotalPrivateLessons();
                    // success alert removed
                } catch (err) {
                    alert('Dosya yüklenirken hata oluştu: ' + err.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        /* ======== Tüm verileri temizle ======== */
        function clearAllData() {
            if (confirm('TÜM VERİLERİNİZ SİLİNECEK!\nBu işlem geri alınamaz. Devam edilsin mi?')) {
                students = []; lessonRecords = [];
                localStorage.removeItem('students'); localStorage.removeItem('lessonRecords');
                renderSchedule(); updateStats(); updateStudentCount(); updateTotalPrivateLessons();
                // success removed
            }
        }

        /* ======== Window click - modal dışına tıklayınca kapat ======== */
        window.onclick = function (e) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (e.target === modal) modal.style.display = 'none';
            });
        }

        /* ======== STATS DETAIL: tıklanınca açılan liste (weekly / monthly / pending) ======== */
        function openStatsDetail(type) {
            const title = document.getElementById('statsDetailTitle');
            const list = document.getElementById('statsDetailList');
            list.innerHTML = '';
            title.textContent = (type === 'weekly' ? 'Bu Haftanın Kazançları' : (type === 'monthly' ? 'Bu Ayın Kazançları' : 'Bekleyen Ödemeler'));

            const now = new Date();
            let start;
            if (type === 'weekly') {
                const today = new Date(); const diff = (today.getDay() + 6) % 7; start = new Date(today); start.setDate(today.getDate() - diff); start.setHours(0, 0, 0, 0);
            } else if (type === 'monthly') {
                start = new Date(now.getFullYear(), now.getMonth(), 1); start.setHours(0, 0, 0, 0);
            }

            let relevant = [];
            if (type === 'pending') {
                relevant = lessonRecords.filter(r => !r.paid);
            } else {
                relevant = lessonRecords.filter(r => {
                    const d = new Date(r.date);
                    return d >= start && r.paid;
                });
            }

            if (relevant.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#6c757d;padding:10px;">İlgili kayıt bulunamadı.</p>';
                openModal('statsDetailModal');
                return;
            }

            if (type === 'pending') {
                // Bekleyen ödemeler için eski mantığı koru
                relevant.sort((a, b) => new Date(b.date) - new Date(a.date));
                relevant.forEach(rec => {
                    const div = document.createElement('div'); div.className = 'history-item';
                    const dateStr = new Date(rec.date).toLocaleDateString('tr-TR');
                    div.innerHTML = `<div><strong>${rec.studentName}</strong><br>📅 ${dateStr}<br><small>₺${rec.fee.toFixed(0)}</small></div>`;
                    const actions = document.createElement('div'); actions.className = 'history-actions';
                    const payBtn = document.createElement('button'); payBtn.className = 'btn-small unpaid'; payBtn.textContent = 'Ödendi Yap';
                    payBtn.onclick = () => {
                        rec.paid = true; saveLessonRecords();
                        updateStats();
                        div.remove();
                    };
                    actions.appendChild(payBtn);
                    div.appendChild(actions);
                    list.appendChild(div);
                });
            } else {
                // Haftalık/aylık kazanç için öğrencilere göre grupla
                const studentGroups = {};
                relevant.forEach(rec => {
                    if (!studentGroups[rec.studentName]) {
                        studentGroups[rec.studentName] = [];
                    }
                    studentGroups[rec.studentName].push(rec);
                });

                // Her öğrenci için bir satır göster
                Object.keys(studentGroups).sort().forEach(studentName => {
                    const studentRecords = studentGroups[studentName];
                    const totalAmount = studentRecords.reduce((sum, rec) => sum + rec.fee, 0);
                    const lessonCount = studentRecords.length;

                    const div = document.createElement('div'); div.className = 'history-item';
                    div.innerHTML = `<div><strong>${studentName}</strong><br><small>${lessonCount} ders - ₺${totalAmount.toFixed(0)}</small></div>`;

                    const actions = document.createElement('div'); actions.className = 'history-actions';
                    const detailBtn = document.createElement('button'); detailBtn.className = 'btn-small'; detailBtn.textContent = 'Detaylar';
                    detailBtn.onclick = () => showStudentPeriodDetails(studentName, studentRecords, div, type);
                    actions.appendChild(detailBtn);

                    div.appendChild(actions);
                    list.appendChild(div);
                });
            }

            openModal('statsDetailModal');
        }

        // Öğrencinin dönemlik ders detaylarını göster
        function showStudentPeriodDetails(studentName, records, containerDiv, periodType) {
            let existing = containerDiv.querySelector('.period-details');
            const detailBtn = containerDiv.querySelector('.btn-small');

            if (existing) {
                existing.remove();
                if (detailBtn) detailBtn.textContent = 'Detaylar';
                return;
            }

            const box = document.createElement('div');
            box.className = 'period-details';
            box.style.marginTop = '8px';
            box.style.background = '#f8f9fa';
            box.style.padding = '8px';
            box.style.borderRadius = '6px';
            box.style.width = '100%';

            const periodTitle = periodType === 'weekly' ? 'Bu Haftaki Dersleri' : 'Bu Ayki Dersleri';
            box.innerHTML = `<strong>${periodTitle}:</strong>`;

            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            records.forEach(rec => {
                const rdiv = document.createElement('div');
                rdiv.style.padding = '4px';
                rdiv.style.borderBottom = '1px solid #eee';
                rdiv.innerHTML = `📅 ${new Date(rec.date).toLocaleDateString('tr-TR')} — ₺${rec.fee.toFixed(0)}`;
                box.appendChild(rdiv);
            });

            // Detayları ana div içindeki ilk elementi (sol taraf) sonrasına ekle
            const firstChild = containerDiv.firstChild;
            if (firstChild.nextSibling) {
                containerDiv.insertBefore(box, firstChild.nextSibling);
            } else {
                containerDiv.appendChild(box);
            }

            if (detailBtn) detailBtn.textContent = 'Kapat';
        }

        /* inline öğrenci geçmiş gösterimi (statsDetail içinde) */
        function openInlineStudentHistory(studentName, containerDiv) {
            // alt kısmı toggle'lı bir kutu ile göster
            let existing = containerDiv.querySelector('.inline-history');
            if (existing) { existing.remove(); return; }
            const box = document.createElement('div'); box.className = 'inline-history'; box.style.marginTop = '8px';
            const records = lessonRecords.filter(r => r.studentName === studentName).sort((a, b) => new Date(b.date) - new Date(a.date));
            if (records.length === 0) {
                box.innerHTML = '<div style="padding:8px;color:#666;">Kayıt bulunamadı.</div>';
            } else {
                records.forEach(rec => {
                    const rdiv = document.createElement('div'); rdiv.style.padding = '6px'; rdiv.style.borderBottom = '1px solid #eee';
                    rdiv.innerHTML = `<strong>${new Date(rec.date).toLocaleDateString('tr-TR')}</strong> — ₺${rec.fee.toFixed(0)} — ${rec.paid ? '✅ Ödendi' : '❌ Ödenmedi'}`;
                    box.appendChild(rdiv);
                });
            }
            containerDiv.appendChild(box);
        }

        /* ======== Öğrenci listesi modal ======== */
        function openStudentListModal() {
            const container = document.getElementById('studentListContainer');
            container.innerHTML = '';
            if (students.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#6c757d;padding:10px;">Henüz öğrenci yok.</p>';
            } else {
                students.forEach(s => {
                    const card = document.createElement('div'); card.className = 'student-card';
                    card.innerHTML = `<div><strong>${s.name}</strong><div style="color:#6c757d;font-size:0.9em">Ücret: ₺${(s.fee || 0).toFixed(0)} — Günler: ${s.schedule.map(x => dayName(x.day)).join(', ')}</div></div>`;
                    const actions = document.createElement('div');
                    const openBtn = document.createElement('button'); openBtn.className = 'btn-small'; openBtn.textContent = 'Detay'; openBtn.onclick = () => { closeModal('studentListModal'); openStudentDetailModal(s.name); };
                    actions.appendChild(openBtn);
                    card.appendChild(actions);
                    container.appendChild(card);
                });
            }
            openModal('studentListModal');
        }

        /* toplam özel ders detay modal (tıklanınca haftalık dersleri listeler) */
        function openTotalLessonsModal() {
            const box = document.getElementById('totalLessonsList'); box.innerHTML = '';
            // her öğrenci-lesson programını göster (haftalık)
            if (students.length === 0) {
                box.innerHTML = '<p style="text-align:center;color:#6c757d;padding:10px;">Henüz öğrenci yok.</p>';
                openModal('totalLessonsModal'); return;
            }
            students.forEach(s => {
                s.schedule.forEach(sch => {
                    const div = document.createElement('div'); div.className = 'history-item';
                    div.innerHTML = `<div><strong>${s.name}</strong><div>${dayName(sch.day)} — ${sch.time}</div></div><div style="font-weight:700;color:#4CAF50;">₺${(s.fee || 0).toFixed(0)}</div>`;
                    box.appendChild(div);
                });
            });
            openModal('totalLessonsModal');
        }

        /* ======== Geçmiş modal: aylık raporlar (lessonRecords'ten türetilir) ======== */
        function openHistoryModal() {
            const container = document.getElementById('historyList'); container.innerHTML = '';
            if (lessonRecords.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#6c757d;padding:10px;">Henüz ders kaydı bulunmuyor.</p>';
                openModal('historyModal'); return;
            }
            // group by YYYY-MM
            const groups = {};
            lessonRecords.forEach(r => {
                const d = new Date(r.date);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                groups[key] = groups[key] || [];
                groups[key].push(r);
            });
            // sırala anahtarları büyükten küçüğe
            const keys = Object.keys(groups).sort((a, b) => b.localeCompare(a));
            keys.forEach(k => {
                const arr = groups[k];
                const total = arr.reduce((a, b) => a + b.fee, 0);
                const lessons = arr.length;
                const div = document.createElement('div'); div.className = 'history-item';

                // Ay ismini Türkçe formatla
                const [year, month] = k.split('-');
                const monthNames = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
                const displayName = `${monthNames[parseInt(month) - 1]} ${year}`;

                div.innerHTML = `<div><strong>${displayName}</strong><div style="color:#6c757d">${lessons} ders</div></div><div style="text-align:right"><div style="font-weight:700;color:#4CAF50;font-size:1.3em;">₺${total.toFixed(0)}</div><button class="btn-small" onclick="openMonthDetails('${k}')">Detaylar</button></div>`;
                container.appendChild(div);
            });
            openModal('historyModal');
        }

        function openMonthDetails(key) {
            // key = YYYY-MM
            const container = document.getElementById('historyList');
            const arr = lessonRecords.filter(r => {
                const d = new Date(r.date);
                const k = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                return k === key;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
            // replace content with detail list + back button
            const [year, month] = key.split('-');
            const monthNames = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            const displayName = `${monthNames[parseInt(month) - 1]} ${year}`;
            container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;"><h3>${displayName} detay</h3><button class="btn-small" onclick="openHistoryModal()">Geri</button></div>`;
            if (arr.length === 0) { container.innerHTML += '<p style="text-align:center;color:#6c757d;padding:10px;">Kayıt yok</p>'; return; }
            arr.forEach(r => {
                const d = new Date(r.date);
                const div = document.createElement('div'); div.className = 'history-item';
                div.innerHTML = `<div><strong>${r.studentName}</strong><div style="color:#6c757d">${d.toLocaleDateString('tr-TR')}</div></div><div style="text-align:right"><div style="font-weight:700">₺${r.fee.toFixed(0)}</div><div style="color:${r.paid ? '#4CAF50' : '#f44336'}">${r.paid ? 'Ödendi' : 'Ödenmedi'}</div></div>`;
                container.appendChild(div);
            });
        }

        /* ======== small helpers ======== */
        function dayName(index) {
            const arr = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
            return arr[index];
        }

        /* ======== Başlangıç: schedule ve stat update helper çağrıları ======== */
        function updateAllViews() {
            renderSchedule();
            updateStats();
            updateStudentCount();
            updateTotalPrivateLessons();
        }

        /* call updateAllViews when data changes */
        function saveStudentsAndUpdate() {
            saveStudents(); updateAllViews();
        }

        /* ======== Sayfa yüklemede çağrılan diğer yardımcılar (başlangıçta zaten çağrıldı) ======== */

        /* ======== Son: önemli notlar ========
         - Başarı bildirimleri (alert "başarıyla eklendi" vb.) istek üzerine kaldırıldı.
         - Kritik onay gerektiren işlemlerde confirm() bırakıldı (silme, veri üzerine yazma).
         - Saat/dakika kutuları küçültüldü ve edit modalda yeni gün eklerken eski değerler korunacak şekilde düzenlendi.
         - "Bu hafta / Bu ay / Bekleyen" tıklanabilir; detay modalında öğrenciye göre açma, ödeme işaretleme gibi işlemler yapılır.
         - Potansiyel aylık gelir, ay içindeki gerçek tarihlere göre hesaplanır.
         - Geçmiş (aylık) raporları lessonRecords üzerinden türetilir (ay bazlı).
        ======================================== */

    </script>
</body>

</html>